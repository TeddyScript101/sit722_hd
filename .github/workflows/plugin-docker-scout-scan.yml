name: Plugin - Docker Scout Scan

on:
  workflow_dispatch:
    inputs:
      IMAGE_NAME:
        description: "Docker image name"
        required: true
        default: "my-image"
      IMAGE_TAG:
        description: "Docker image tag"
        required: true
        default: "latest"
  workflow_call:
    inputs:
      IMAGE_NAME:
        description: "Docker image name"
        required: true
        type: string
      IMAGE_TAG:
        description: "Docker image tag"
        required: true
        type: string

jobs:
  scout-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        run: |
          echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Install Docker Scout CLI
        run: |
          if ! docker scout version &>/dev/null; then
            echo "Installing Docker Scout..."
            curl -fsSL https://get.docker.com/scout/install.sh | sh
          fi

      - name: Scan Docker Image
        run: |
          echo "Scanning image: ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }}"
          docker scout cves ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }} --format sarif --output scout-report.sarif.json
          docker scout cves ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }}
          echo "âœ… Docker Scout scan completed"
