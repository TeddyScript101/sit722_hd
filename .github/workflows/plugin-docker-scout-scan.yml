name: Plugin - Docker Scout Scan

on:
  workflow_dispatch:
    inputs:
      IMAGE_NAME:
        description: "Docker image name"
        required: true
        default: "my-image"
      IMAGE_TAG:
        description: "Docker image tag"
        required: true
        default: "latest"
  workflow_call:
    inputs:
      IMAGE_NAME:
        description: "Docker image name"
        required: true
        type: string
      IMAGE_TAG:
        description: "Docker image tag"
        required: true
        type: string

jobs:
  scout-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        run: |
          echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Install Docker Scout CLI
        run: |
          # Install Docker Scout CLI
          curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --
          # Add to PATH
          echo "$HOME/.docker/scout" >> $GITHUB_PATH

      - name: Verify Docker Scout Installation
        run: |
          docker scout version

      - name: Pull Docker Image
        run: |
          echo "Pulling image: ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }}"
          docker pull ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }}

      - name: Scan Docker Image for CVEs
        run: |
          echo "Scanning image: ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }}"

          # Run basic CVE scan
          docker scout cves ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }}

          echo "âœ… Docker Scout scan completed"

      - name: Generate SARIF Report (Optional)
        run: |
          # Only run if SARIF format is supported
          if docker scout cves --help | grep -q "sarif"; then
            echo "Generating SARIF report..."
            docker scout cves ${{ github.event.inputs.IMAGE_NAME || inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_TAG || inputs.IMAGE_TAG }} --format sarif --output scout-report.sarif
          else
            echo "SARIF format not supported in this version"
          fi
        continue-on-error: true

      - name: Upload SARIF Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: scout-report.sarif
        continue-on-error: true
